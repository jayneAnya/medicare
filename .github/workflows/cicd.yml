name: Build and push docker image to ECR

on:
  push:

jobs:
  build-push:
    runs-on: ubuntu-latest
    steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Configure AWS credentials
          run: |
            aws configure set aws_access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
            aws configure set aws_secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            aws configure set default.region ${{ secrets.AWS_REGION }}

        - name: Login to Amazon ECR
          run: |
           aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin 657103446220.dkr.ecr.us-east-1.amazonaws.com
        
        - name: Build and push Docker image to ECR
          run: |
            docker build -t mediplus:${{ github.run_number }} .
            docker tag mediplus:${{ github.run_number }} 657103446220.dkr.ecr.us-east-1.amazonaws.com/mediplus:${{ github.run_number }}
            docker push 657103446220.dkr.ecr.us-east-1.amazonaws.com/mediplus:${{ github.run_number }}


  deploy:
    runs-on: ubuntu-latest
    needs: build-push
    steps: 
      - name: check my ssh key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > mykey.pem
          chmod 600 mykey.pem
          cat mykey.pem

          ssh -o StrictHostKeyChecking=no -i mykey.pem ubuntu@34.229.86.229 "docker pull 657103446220.dkr.ecr.us-east-1.amazonaws.com/mediplus:{{ github.run_number }}"

                    ssh -o StrictHostKeyChecking=no -i mykey.pem ubuntu@{{ secrets.EC2_HOST }} "docker rm -f mediplus"

          ssh -o StrictHostKeyChecking=no -i mykey.pem ubuntu@{{ secrets.EC2_HOST }} "docker run -d --name mediplus -p 80:80 657103446220.dkr.ecr.us-east-1.amazonaws.com/mediplus:{{ github.run_number }}"